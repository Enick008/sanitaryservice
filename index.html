<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบแจ้งงานดูดสิ่งปฏิกูล</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            margin: 0; /* Remove default body margin */
            padding: 20px;
            background-color: #F8F8F8; /* Very light gray, typical iOS background */
            color: #333;
            line-height: 1.6;
        }
        header {
            text-align: center;
            margin-bottom: 30px; /* Space below header */
            padding: 15px 0; /* Add some padding for visual separation */
            background-color: #FFFFFF; /* White background for header area */
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* Softer, more subtle shadow */
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 20px; /* Adjust margin to create space between header and container */
        }
        header img {
            height: 100px; /* Fixed height as requested */
            width: auto; /* Maintain aspect ratio */
            display: block; /* Ensures centering with margin: auto */
            margin: 0 auto; /* Center the image */
            border-radius: 8px; /* Consistent with other elements */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Subtle shadow for the logo */
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #FFFFFF; /* Pure white content background */
            padding: 30px; /* Increased padding for more breathing room */
            border-radius: 12px; /* More rounded corners */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* Softer, more subtle shadow */
        }
        h2 {
            color: #E6007A; /* A vibrant pink for titles */
            text-align: center;
            margin-bottom: 30px; /* More space below title */
            font-weight: 600; /* Slightly bolder for headings */
        }
        .form-group {
            margin-bottom: 20px; /* More space between form groups */
        }
        label {
            display: block;
            margin-bottom: 8px; /* Space between label and input */
            font-weight: 500; /* Medium font weight */
            color: #555;
        }
        input[type="text"],
        input[type="tel"],
        input[type="number"],
        textarea,
        select { /* Added select to this rule */
            width: calc(100% - 20px); /* Adjust width for padding */
            padding: 12px; /* Increased padding inside inputs */
            border: 1px solid #E0E0E0; /* Light gray border */
            border-radius: 8px; /* Slightly rounded input fields */
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus { /* Added select to this rule */
            border-color: #FF66B2; /* Pink border on focus */
            outline: none; /* Remove default outline */
        }
        input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2); /* Slightly larger checkbox */
        }
        button {
            background-color: #FF66B2; /* A soft, appealing pink for buttons */
            color: white;
            padding: 12px 18px; /* Larger padding for buttons */
            border: none;
            border-radius: 8px; /* Rounded buttons */
            cursor: pointer;
            font-size: 17px;
            width: 100%;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Subtle button shadow */
        }
        button:hover {
            background-color: #E6007A; /* Darker pink on hover */
            transform: translateY(-1px); /* Slight lift effect */
        }
        button:active {
            transform: translateY(0); /* Press effect */
        }
        .action-buttons {
            display: flex;
            gap: 5px; /* Space between action buttons */
            justify-content: center; /* Center buttons within the cell */
        }
        .action-buttons button {
            width: auto; /* Allow buttons to size based on content */
            padding: 8px 12px; /* Smaller padding for individual action buttons */
            font-size: 14px;
            box-shadow: none; /* No extra shadow for nested buttons */
        }
        .action-buttons button.save-btn {
            background-color: #4CAF50; /* Green for Save */
        }
        .action-buttons button.save-btn:hover {
            background-color: #45a049;
        }
        .action-buttons button.cancel-btn {
            background-color: #f44336; /* Red for Cancel */
        }
        .action-buttons button.cancel-btn:hover {
            background-color: #da190b;
        }
        .action-buttons button.delete-btn {
            background-color: #F44336; /* Red for Delete */
        }
        .action-buttons button.delete-btn:hover {
            background-color: #da190b;
        }

        .message {
            margin-top: 25px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            display: none;
            font-weight: 500;
        }
        .success {
            background-color: #E0FFE0; /* Lighter green for success */
            color: #1A7A1A; /* Darker green text */
            border: 1px solid #B3FFB3;
        }
        .error {
            background-color: #FFE0E0; /* Lighter red for error */
            color: #A03333; /* Darker red text */
            border: 1px solid #FFB3B3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background-color: #FFFFFF;
            border-radius: 8px;
            overflow: hidden; /* Ensures rounded corners apply to table */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Soft shadow for table */
        }
        th, td {
            border: 1px solid #F0F0F0; /* Very light border for table cells */
            padding: 12px;
            text-align: left;
            word-wrap: break-word;
        }
        th {
            background-color: #F8F8F8; /* Light gray header */
            font-weight: 600;
            color: #555;
        }
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background-color: #FFFFFF;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .tab-button {
            padding: 12px 25px;
            margin: 5px;
            border: none; /* No border for tab buttons initially */
            border-radius: 8px;
            cursor: pointer;
            background-color: #F0F0F0; /* Light gray for inactive tabs */
            color: #666;
            transition: background-color 0.3s ease, color 0.3s ease, box-shadow 0.2s ease;
            font-size: 16px;
            font-weight: 500;
            flex-grow: 1;
            max-width: 30%;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle shadow for inactive tabs */
        }
        .tab-button.active {
            background-color: #FF66B2; /* Pink for active tab */
            color: white;
            box-shadow: 0 3px 8px rgba(255, 102, 178, 0.3); /* Stronger, pink-tinted shadow for active tab */
        }
        .tab-button:hover:not(.active) {
            background-color: #E0E0E0; /* Slightly darker gray on hover for inactive tabs */
        }
        .tab-content {
            display: none;
            padding: 10px;
        }
        .tab-content.active {
            display: block;
        }

        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #E0E0E0;
            border-radius: 10px;
            background-color: #FDFDFD;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Inner shadow for filter box */
        }
        .search-filters button {
            grid-column: 1 / -1;
            margin-top: 15px;
        }

        #statsContent p {
            margin-bottom: 10px;
            font-size: 16px;
            color: #444;
        }
        #statsContent strong {
            color: #E6007A; /* Pink for strong stats labels */
        }
        #statsContent h4 {
            margin-top: 25px;
            color: #E6007A;
            font-weight: 600;
        }
        #staffStatsList {
            list-style-type: none; /* Remove default bullet points */
            padding-left: 0;
            margin-top: 15px;
        }
        #staffStatsList li {
            background-color: #FFF0F5; /* Light pink background for list items */
            margin-bottom: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #FFD1E0; /* Lighter pink border */
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: #666;
        }
        footer {
            text-align: center;
            margin-top: 40px; /* Space above footer */
            padding: 20px;
            background-color: #FFF0F5; /* A very light pink/reddish hue for consistency with stats list item */
            color: #E6007A; /* Use the vibrant pink for text */
            border-radius: 12px; /* Consistent rounded corners */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* Consistent shadow */
            font-size: 14px;
            font-weight: 500;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Custom Modal for Confirmation */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex; /* Use flex for centering */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 400px;
            text-align: center;
            position: relative; /* For close button positioning */
        }

        .modal-content h3 {
            color: #E6007A;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            gap: 10px;
        }

        .modal-buttons button {
            width: 48%; /* Adjust width for two buttons */
            padding: 10px 15px;
            font-size: 16px;
            border-radius: 8px;
            box-shadow: none; /* Remove extra shadow for modal buttons */
        }

        .modal-buttons button.confirm-yes {
            background-color: #F44336; /* Red for Yes */
        }
        .modal-buttons button.confirm-yes:hover {
            background-color: #da190b;
        }
        .modal-buttons button.confirm-no {
            background-color: #666; /* Grey for No */
        }
        .modal-buttons button.confirm-no:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <header>
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Seal_of_Ko_Samui.png" alt="Seal of Ko Samui Logo">
    </header>
    <div class="container">
        <h2>ระบบแจ้งงานดูดสิ่งปฏิกูล</h2>

        <!-- Tab Buttons -->
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('addBookingTab', event)">ระบบจอง</button>
            <button class="tab-button" onclick="showTab('searchReportTab', event)">ค้นหาและรายงานผล</button>
            <button class="tab-button" onclick="showTab('statsTab', event)">สถิติ</button>
        </div>

        <!-- Add Booking Tab Content -->
        <div id="addBookingTab" class="tab-content active">
            <form id="bookingForm">
                <div class="form-group">
                    <label for="name">ชื่อลูกค้า:</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="phone">เบอร์โทรศัพท์:</label>
                    <input type="tel" id="phone" required>
                </div>
                <div class="form-group">
                    <label for="house_number">เลขที่บ้าน:</label>
                    <input type="text" id="house_number">
                </div>
                <div class="form-group">
                    <label for="village_number">หมู่บ้าน:</label>
                    <input type="text" id="village_number">
                </div>
                <div class="form-group">
                    <label for="subdistrict">ตำบล:</label>
                    <select id="subdistrict">
                        <option value="">เลือกตำบล</option>
                        <option value="อ่างทอง">อ่างทอง</option>
                        <option value="ลิปะน้อย">ลิปะน้อย</option>
                        <option value="ตลิ่งงาม">ตลิ่งงาม</option>
                        <option value="หน้าเมือง">หน้าเมือง</option>
                        <option value="มะเร็ต">มะเร็ต</option>
                        <option value="บ่อผุด">บ่อผุด</option>
                        <option value="แม่น้ำ">แม่น้ำ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="staff">พนักงานผู้รับผิดชอบ:</label>
                    <select id="staff">
                        <option value="">เลือกพนักงาน</option>
                        <option value="ศุภชัย เปี่ยมประถม">ศุภชัย เปี่ยมประถม</option>
                        <option value="ไพรวัลย์ คำชาลี">ไพรวัลย์ คำชาลี</option>
                        <option value="ชวลิต ใจแผ้ว">ชวลิต ใจแผ้ว</option>
                        <option value="ชาคริต ปัญญา">ชาคริต ปัญญา</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amount">ค่าบริการ (บาท):</label>
                    <input type="number" id="amount" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <input type="checkbox" id="paid">
                    <label for="paid" style="display: inline;">ชำระแล้ว</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="completed">
                    <label for="completed" style="display: inline;">งานเสร็จสิ้น</label>
                </div>
                <div class="form-group">
                    <label for="notes">หมายเหตุ:</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                <button type="submit">แจ้งงาน</button>
            </form>
            <div id="message" class="message"></div>
        </div>

        <!-- Search and Report Tab Content -->
        <div id="searchReportTab" class="tab-content">
            <div class="search-filters">
                <div class="form-group">
                    <label for="searchName">ชื่อลูกค้า/เบอร์โทร:</label>
                    <input type="text" id="searchName" placeholder="ค้นหาด้วยชื่อหรือเบอร์โทร">
                </div>
                <div class="form-group">
                    <label for="filterStaff">พนักงาน:</label>
                    <select id="filterStaff">
                        <option value="">ทั้งหมด</option>
                        <option value="ศุภชัย เปี่ยมประถม">ศุภชัย เปี่ยมประถม</option>
                        <option value="ไพรวัลย์ คำชาลี">ไพรวัลย์ คำชาลี</option>
                        <option value="ชวลิต ใจแผ้ว">ชวลิต ใจแผ้ว</option>
                        <option value="ชาคริต ปัญญา">ชาคริต ปัญญา</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="filterSubdistrict">ตำบล:</label>
                    <select id="filterSubdistrict">
                        <option value="">ทั้งหมด</option>
                        <option value="อ่างทอง">อ่างทอง</option>
                        <option value="ลิปะน้อย">ลิปะน้อย</option>
                        <option value="ตลิ่งงาม">ตลิ่งงาม</option>
                        <option value="หน้าเมือง">หน้าเมือง</option>
                        <option value="มะเร็ต">มะเร็ต</option>
                        <option value="บ่อผุด">บ่อผุด</option>
                        <option value="แม่น้ำ">แม่น้ำ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filterCompleted">สถานะงาน:</label>
                    <select id="filterCompleted">
                        <option value="">ทั้งหมด</option>
                        <option value="Yes">เสร็จสิ้น</option>
                        <option value="No">ยังไม่เสร็จสิ้น</option>
                    </select>
                </div>
                <button onclick="applyFilters()">ค้นหา/กรอง</button>
            </div>
            <div id="bookingsTableContainer">
                <!-- Filtered bookings will be loaded here -->
            </div>
            <div id="viewMessage" class="message"></div>
        </div>

        <!-- Statistics Tab Content -->
        <div id="statsTab" class="tab-content">
            <h3>สรุปสถิติ</h3>
            <div id="statsContent">
                <!-- Statistics will be loaded here -->
                <p><strong>จำนวนงานทั้งหมด:</strong> <span id="totalBookings">0</span></p>
                <p><strong>งานที่เสร็จสิ้น:</strong> <span id="completedBookings">0</span></p>
                <p><strong>งานที่ยังไม่เสร็จสิ้น:</strong> <span id="incompleteBookings">0</span></p>
                <p><strong>ยอดรวมค่าบริการทั้งหมด:</strong> <span id="totalAmount">0</span> บาท</p>
                <h4>งานต่อพนักงาน:</h4>
                <ul id="staffStatsList"></ul>
            </div>
            <div id="statsMessage" class="message"></div>
        </div>

    </div>
    <footer>
        <p>&copy;2025 ระบบให้บริการรถดูดสิ่งปฏิกูล กองช่างสุขาภิบาล โดย นายธีรศักดิ์ พูลเขาล้าน</p>
    </footer>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 id="modalTitle">ยืนยันการลบ?</h3>
            <p id="modalBody">คุณต้องการลบรายการนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
            <div class="modal-buttons">
                <button class="confirm-yes" id="confirmYesBtn">ใช่</button>
                <button class="confirm-no" id="confirmNoBtn">ไม่</button>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyyahkXofdS557MnH_9nHJm7K_a5Lo7LNIp87_E4ly2wiJ9zg50tZjNkWIXha1ExVcUpA/exec';

        // Static lists for dropdowns
        const STAFF_OPTIONS = [
            "ศุภชัย เปี่ยมประถม",
            "ไพรวัลย์ คำชาลี",
            "ชวลิต ใจแผ้ว",
            "ชาคริต ปัญญา"
        ];

        const SUBDISTRICT_OPTIONS = [
            "อ่างทอง",
            "ลิปะน้อย",
            "ตลิ่งงาม",
            "หน้าเมือง",
            "มะเร็ต",
            "บ่อผุด",
            "แม่น้ำ"
        ];

        let allBookingsData = []; // Stores all fetched bookings
        let editingRowTimestamp = null; // Keeps track of which row is currently being edited

        // --- Tab Switching Logic ---
        function showTab(tabId, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                document.querySelector('.tab-buttons .tab-button').classList.add('active');
            }

            // Load data based on the activated tab
            if (tabId === 'searchReportTab') {
                fetchAndRenderAllBookings();
            } else if (tabId === 'statsTab') {
                fetchAndRenderAllBookings(true);
            }
        }

        // --- Data Fetching Logic ---
        function fetchAndRenderAllBookings(forStats = false) {
            const messageDiv = forStats ? document.getElementById('statsMessage') : document.getElementById('viewMessage');
            messageDiv.style.display = 'none';

            if (!forStats) {
                document.getElementById('bookingsTableContainer').innerHTML = '<p>กำลังโหลดข้อมูล...</p>';
            } else {
                document.getElementById('totalBookings').textContent = 'กำลังโหลด...';
                document.getElementById('completedBookings').textContent = 'กำลังโหลด...';
                document.getElementById('incompleteBookings').textContent = 'กำลังโหลด...';
                document.getElementById('totalAmount').textContent = 'กำลังโหลด...';
                document.getElementById('staffStatsList').innerHTML = '<p>กำลังโหลด...</p>';
            }

            const url = `${WEB_APP_URL}?action=getBookings&callback=handleGetBookingsResponse`;

            fetch(url)
                .then(response => response.text())
                .then(text => {
                    eval(text);
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    messageDiv.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + error.message;
                    messageDiv.className = 'message error';
                    messageDiv.style.display = 'block';
                    if (!forStats) {
                        document.getElementById('bookingsTableContainer').innerHTML = '';
                    } else {
                        document.getElementById('totalBookings').textContent = '0';
                        document.getElementById('completedBookings').textContent = '0';
                        document.getElementById('incompleteBookings').textContent = '0';
                        document.getElementById('totalAmount').textContent = '0';
                        document.getElementById('staffStatsList').innerHTML = '';
                    }
                });
        }

        function handleGetBookingsResponse(response) {
            const viewMessageDiv = document.getElementById('viewMessage');
            const statsMessageDiv = document.getElementById('statsMessage');
            const currentActiveTab = document.querySelector('.tab-content.active').id;

            if (response.success) {
                allBookingsData = response.data || [];

                if (currentActiveTab === 'searchReportTab') {
                    applyFilters();
                } else if (currentActiveTab === 'statsTab') {
                    renderStatistics(allBookingsData);
                }
            } else {
                if (currentActiveTab === 'searchReportTab') {
                    viewMessageDiv.textContent = 'ไม่สามารถโหลดข้อมูลได้: ' + response.error;
                    viewMessageDiv.className = 'message error';
                    viewMessageDiv.style.display = 'block';
                    document.getElementById('bookingsTableContainer').innerHTML = '';
                } else if (currentActiveTab === 'statsTab') {
                    statsMessageDiv.textContent = 'ไม่สามารถโหลดข้อมูลได้: ' + response.error;
                    statsMessageDiv.className = 'message error';
                    statsMessageDiv.style.display = 'block';
                    renderStatistics([]);
                }
            }
        }

        // --- Add Booking Logic ---
        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const messageDiv = document.getElementById('message');
            messageDiv.style.display = 'none';

            const bookingData = {
                timestamp: new Date().toISOString(),
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                house_number: document.getElementById('house_number').value,
                village_number: document.getElementById('village_number').value,
                subdistrict: document.getElementById('subdistrict').value,
                staff: document.getElementById('staff').value,
                amount: parseFloat(document.getElementById('amount').value) || 0,
                paid: document.getElementById('paid').checked,
                completed: document.getElementById('completed').checked,
                notes: document.getElementById('notes').value
            };

            const url = `${WEB_APP_URL}?action=addBooking&data=${encodeURIComponent(JSON.stringify(bookingData))}&callback=handleAddBookingResponse`;

            fetch(url)
                .then(response => response.text())
                .then(text => {
                    eval(text);
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    displayMessage('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message, 'error');
                });
        });

        function handleAddBookingResponse(response) {
            const messageDiv = document.getElementById('message');
            if (response.success) {
                displayMessage('แจ้งงานสำเร็จ!', 'success');
                document.getElementById('bookingForm').reset();
                document.getElementById('staff').value = ""; // Reset staff dropdown
                document.getElementById('subdistrict').value = ""; // Reset subdistrict dropdown
            } else {
                displayMessage('แจ้งงานไม่สำเร็จ: ' + response.error, 'error');
            }
        }

        function displayMessage(msg, type, targetDivId = 'message') { // Added targetDivId for flexibility
            const messageDiv = document.getElementById(targetDivId);
            messageDiv.textContent = msg;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
        }

        // --- Search and Report Tab Functions ---
        function applyFilters() {
            const searchName = document.getElementById('searchName').value.toLowerCase();
            const filterStaff = document.getElementById('filterStaff').value;
            const filterSubdistrict = document.getElementById('filterSubdistrict').value;
            const filterCompleted = document.getElementById('filterCompleted').value;

            const filteredBookings = allBookingsData.filter(booking => {
                const matchesName = !searchName ||
                                    (booking.name && String(booking.name).toLowerCase().includes(searchName)) ||
                                    (booking.phone && String(booking.phone).toLowerCase().includes(searchName));

                const matchesStaff = !filterStaff || booking.staff === filterStaff;
                const matchesSubdistrict = !filterSubdistrict || booking.subdistrict === filterSubdistrict;
                const matchesCompleted = !filterCompleted ||
                                         (filterCompleted === "Yes" && booking.completed === true) ||
                                         (filterCompleted === "No" && booking.completed === false);

                return matchesName && matchesStaff && matchesSubdistrict && matchesCompleted;
            });

            renderBookingsTable(filteredBookings);
        }

        function renderBookingsTable(bookings) {
            const bookingsTableContainer = document.getElementById('bookingsTableContainer');
            if (bookings.length === 0) {
                bookingsTableContainer.innerHTML = '<p>ไม่พบรายการงานที่ตรงกับเงื่อนไขการค้นหา</p>';
                return;
            }

            let tableHTML = '<table><thead><tr>';
            const headers = Object.keys(bookings[0]).filter(header => header.toLowerCase() !== 'timestamp');

            headers.forEach(header => {
                const displayHeader = header.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                tableHTML += `<th>${displayHeader}</th>`;
            });
            tableHTML += '<th>Actions</th>'; // Add Actions header
            tableHTML += '</tr></thead><tbody>';

            bookings.forEach(booking => {
                tableHTML += `<tr data-timestamp="${booking.timestamp}">`; // Add data-timestamp attribute
                headers.forEach(header => {
                    const displayValue = (header === 'paid' || header === 'completed') ? (booking[header] ? 'Yes' : 'No') : booking[header];
                    // Render cells with a span (display) and a hidden input/select (edit)
                    tableHTML += `<td>
                        <span class="display-mode">${displayValue}</span>
                        <input type="${(header === 'amount') ? 'number' : (header === 'paid' ? 'checkbox' : 'text')}"
                               class="edit-mode" style="display: none;"
                               data-field="${header}" value="${booking[header] !== undefined ? booking[header] : ''}"
                               ${header === 'amount' ? 'step="0.01"' : ''}
                               ${header === 'paid' && booking.paid ? 'checked' : ''}
                        >
                        ${header === 'completed' || header === 'staff' || header === 'subdistrict' ? `
                            <select class="edit-mode" style="display: none;" data-field="${header}">
                                <option value="">${header === 'completed' ? 'เลือกสถานะ' : (header === 'staff' ? 'เลือกพนักงาน' : 'เลือกตำบล')}</option>
                                ${header === 'completed' ? `
                                    <option value="true" ${booking.completed === true ? 'selected' : ''}>Yes</option>
                                    <option value="false" ${booking.completed === false ? 'selected' : ''}>No</option>
                                ` : (header === 'staff' ? `
                                    ${STAFF_OPTIONS.map(opt => `<option value="${opt}" ${booking.staff === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                ` : (header === 'subdistrict' ? `
                                    ${SUBDISTRICT_OPTIONS.map(opt => `<option value="${opt}" ${booking.subdistrict === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                ` : ''))}
                            </select>
                        ` : ''}
                    </td>`;
                });
                // Action buttons
                tableHTML += `<td>
                    <div class="action-buttons">
                        <button class="edit-btn" onclick="enterEditMode(this, '${booking.timestamp}')">แก้ไข</button>
                        <button class="save-btn" style="display: none;" onclick="saveBooking(this, '${booking.timestamp}')">บันทึก</button>
                        <button class="cancel-btn" style="display: none;" onclick="cancelEdit(this, '${booking.timestamp}')">ยกเลิก</button>
                        <button class="delete-btn" onclick="showConfirmModal('${booking.timestamp}', '${booking.name}')">ลบ</button>
                    </div>
                </td>`;
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            bookingsTableContainer.innerHTML = tableHTML;
        }

        // Stores original values when entering edit mode for cancellation
        const originalRowValues = {};

        function enterEditMode(buttonElement, timestamp) {
            const row = buttonElement.closest('tr');
            if (!row) return;

            editingRowTimestamp = timestamp;

            // Store original values before editing
            const booking = allBookingsData.find(b => b.timestamp === timestamp);
            originalRowValues[timestamp] = { ...booking };

            row.querySelectorAll('.display-mode').forEach(span => span.style.display = 'none');
            row.querySelectorAll('.edit-mode').forEach(input => {
                input.style.display = 'inline-block'; // Or 'block' depending on element type
                if (input.type === 'checkbox') {
                    input.style.display = 'inline'; // Checkbox is inline
                }
            });

            // Show save/cancel, hide edit
            buttonElement.style.display = 'none';
            row.querySelector('.save-btn').style.display = 'inline-block';
            row.querySelector('.cancel-btn').style.display = 'inline-block';
            row.querySelector('.delete-btn').style.display = 'none'; // Hide delete button during edit
        }

        function saveBooking(buttonElement, timestamp) {
            const row = buttonElement.closest('tr');
            if (!row) return;

            const updatedData = {
                timestamp: timestamp
            };
            // Collect data from visible input/select elements
            row.querySelectorAll('.edit-mode').forEach(element => {
                const field = element.dataset.field;
                if (field) {
                    if (element.type === 'checkbox') {
                        updatedData[field] = element.checked;
                    } else if (element.tagName === 'SELECT') {
                        updatedData[field] = element.value;
                    } else {
                        updatedData[field] = element.value;
                    }
                }
            });

            displayMessage('กำลังบันทึกข้อมูล...', 'info', 'viewMessage'); // Show loading message

            const url = `${WEB_APP_URL}?action=updateBooking&data=${encodeURIComponent(JSON.stringify(updatedData))}&callback=handleUpdateBookingResponse`;
            fetch(url)
                .then(response => response.text())
                .then(text => {
                    eval(text);
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    displayMessage('เกิดข้อผิดพลาดในการบันทึก: ' + error.message, 'error', 'viewMessage');
                    exitEditMode(row, timestamp); // Exit edit mode on error
                });
        }

        function handleUpdateBookingResponse(response) {
            const viewMessageDiv = document.getElementById('viewMessage');
            if (response.success) {
                displayMessage('บันทึกข้อมูลสำเร็จ!', 'success', 'viewMessage');
                // Re-fetch and render all data to reflect changes and exit edit mode for all
                fetchAndRenderAllBookings();
                editingRowTimestamp = null; // Clear editing state
            } else {
                displayMessage('บันทึกข้อมูลไม่สำเร็จ: ' + response.error, 'error', 'viewMessage');
                // Keep the row in edit mode on error to allow user to retry or cancel
            }
        }

        function cancelEdit(buttonElement, timestamp) {
            const row = buttonElement.closest('tr');
            if (!row) return;

            // Revert values using stored original data
            const originalData = originalRowValues[timestamp];
            if (originalData) {
                row.querySelectorAll('.edit-mode').forEach(element => {
                    const field = element.dataset.field;
                    if (originalData[field] !== undefined) {
                        if (element.type === 'checkbox') {
                            element.checked = originalData[field];
                        } else {
                            element.value = originalData[field];
                        }
                    }
                });
            }
            exitEditMode(row, timestamp); // Exit edit mode
        }

        function exitEditMode(row, timestamp) {
            row.querySelectorAll('.display-mode').forEach(span => span.style.display = 'inline-block');
            row.querySelectorAll('.edit-mode').forEach(input => input.style.display = 'none');

            // Show edit, hide save/cancel
            row.querySelector('.edit-btn').style.display = 'inline-block';
            row.querySelector('.save-btn').style.display = 'none';
            row.querySelector('.cancel-btn').style.display = 'none';
            row.querySelector('.delete-btn').style.display = 'inline-block'; // Show delete button again

            delete originalRowValues[timestamp]; // Clean up stored original values
            editingRowTimestamp = null; // Clear editing state
        }

        // --- Delete Booking Logic (with custom modal) ---
        let deleteConfirmTimestamp = null;

        function showConfirmModal(timestamp, name) {
            deleteConfirmTimestamp = timestamp;
            const modal = document.getElementById('confirmModal');
            document.getElementById('modalTitle').textContent = 'ยืนยันการลบรายการ?';
            document.getElementById('modalBody').innerHTML = `คุณต้องการลบรายการของ <strong>${name}</strong> ใช่หรือไม่? <br>การกระทำนี้ไม่สามารถย้อนกลับได้`;
            modal.style.display = 'flex'; // Show modal
        }

        function hideConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.style.display = 'none';
            deleteConfirmTimestamp = null; // Clear timestamp
        }

        document.getElementById('confirmYesBtn').addEventListener('click', function() {
            if (deleteConfirmTimestamp) {
                deleteBooking(deleteConfirmTimestamp);
            }
            hideConfirmModal();
        });

        document.getElementById('confirmNoBtn').addEventListener('click', function() {
            hideConfirmModal();
        });

        // Close modal if clicked outside content (optional)
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('confirmModal');
            if (event.target === modal) {
                hideConfirmModal();
            }
        });


        function deleteBooking(timestamp) {
            displayMessage('กำลังลบข้อมูล...', 'info', 'viewMessage'); // Show loading message

            const url = `${WEB_APP_URL}?action=deleteByTimestamp&timestamp=${encodeURIComponent(timestamp)}&callback=handleDeleteBookingResponse`;
            fetch(url)
                .then(response => response.text())
                .then(text => {
                    eval(text);
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    displayMessage('เกิดข้อผิดพลาดในการลบ: ' + error.message, 'error', 'viewMessage');
                });
        }

        function handleDeleteBookingResponse(response) {
            const viewMessageDiv = document.getElementById('viewMessage');
            if (response.success) {
                displayMessage('ลบข้อมูลสำเร็จ!', 'success', 'viewMessage');
                // Re-fetch and render all data to reflect changes
                fetchAndRenderAllBookings();
            } else {
                displayMessage('ลบข้อมูลไม่สำเร็จ: ' + response.error, 'error', 'viewMessage');
            }
        }


        // --- Statistics Tab Functions ---
        function renderStatistics(bookings) {
            let totalBookings = bookings.length;
            let completedBookings = bookings.filter(b => b.completed === true).length;
            let incompleteBookings = totalBookings - completedBookings;
            let totalAmount = bookings.reduce((sum, b) => sum + (parseFloat(b.amount) || 0), 0);

            const staffStats = {};
            bookings.forEach(b => {
                if (b.staff) {
                    staffStats[b.staff] = (staffStats[b.staff] || 0) + 1;
                }
            });

            document.getElementById('totalBookings').textContent = totalBookings;
            document.getElementById('completedBookings').textContent = completedBookings;
            document.getElementById('incompleteBookings').textContent = incompleteBookings;
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);

            const staffStatsList = document.getElementById('staffStatsList');
            staffStatsList.innerHTML = '';
            if (Object.keys(staffStats).length > 0) {
                const sortedStaff = Object.keys(staffStats).sort();
                sortedStaff.forEach(staff => {
                    const li = document.createElement('li');
                    li.textContent = `${staff}: ${staffStats[staff]} งาน`;
                    staffStatsList.appendChild(li);
                });
            } else {
                staffStatsList.innerHTML = '<li>ไม่มีข้อมูลพนักงาน</li>';
            }

            if (totalBookings === 0) {
                document.getElementById('statsContent').innerHTML = '<p>ไม่พบข้อมูลสำหรับแสดงสถิติ</p>';
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showTab('addBookingTab', null);
        });
    </script>
</body>
</html>
