<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ระบบแจ้งงานดูดสิ่งปฏิกูล (ปรับปรุง)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--pink:#FF66B2;--pink-dark:#E6007A;--red:#F44336;--green:#4CAF50;--bg:#F8F8F8;--card:#FFFFFF;--muted:#666;--muted-2:#555;--border:#E0E0E0}
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;margin:0;padding:20px;background:var(--bg);color:#333;line-height:1.6}
    header{max-width:1000px;margin:0 auto 20px;background:var(--card);padding:12px 0;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08);text-align:center}
    header img{height:80px;width:auto;display:block;margin:0 auto;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .container{max-width:1000px;margin:0 auto;background:var(--card);padding:24px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08)}
    h2{color:var(--pink-dark);text-align:center;margin:8px 0 18px;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-12{grid-column:span 12}
    @media (max-width:768px){.col-6,.col-4{grid-column:span 12}}
    .form-group label{display:block;margin:0 0 6px;font-weight:600;color:var(--muted-2)}
    input[type="text"],input[type="tel"],input[type="number"],textarea,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:16px;transition:border-color .2s}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--pink)}
    input[type="checkbox"]{transform:scale(1.1);margin-right:6px}
    button{background:var(--pink);color:#fff;border:0;border-radius:8px;padding:12px 16px;cursor:pointer;font-size:16px;font-weight:700;transition:background .2s,transform .08s;box-shadow:0 2px 5px rgba(0,0,0,.08)}
    button:hover{background:var(--pink-dark)}
    button:active{transform:translateY(1px)}
    .btn-outline{background:#f5f5f5;color:#333}
    .row-actions{display:flex;gap:6px;justify-content:center}
    .btn-green{background:var(--green)}.btn-green:hover{background:#3e8e41}
    .btn-red{background:var(--red)}.btn-red:hover{background:#da190b}
    .message{margin-top:14px;padding:12px;border-radius:8px;text-align:center;display:none;font-weight:600}
    .success{background:#E0FFE0;color:#1A7A1A;border:1px solid #B3FFB3}
    .error{background:#FFE0E0;color:#A03333;border:1px solid #FFB3B3}
    .info{background:#E8F4FF;color:#1f4b7a;border:1px solid #b7dcff}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;background:var(--card);padding:8px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:16px}
    .tab{flex:1 1 30%;background:#F0F0F0;color:#666;border:0;border-radius:8px;padding:12px 18px}
    .tab.active{background:var(--pink);color:#fff;box-shadow:0 3px 8px rgba(255,102,178,.3)}
    .tab-content{display:none}.tab-content.active{display:block}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    th,td{border:1px solid #f0f0f0;padding:10px;text-align:left;vertical-align:top}
    th{background:#F8F8F8;font-weight:700;color:#555}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:8px 0 6px;flex-wrap:wrap}
    .chart-container{position:relative;width:100%;height:340px;margin-top:16px;background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05);padding:12px}
    footer{text-align:center;margin:20px auto 0;padding:16px;background:#FFF0F5;color:var(--pink-dark);border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.08);font-size:14px;font-weight:600;max-width:1000px}
    .modal{display:none;position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center}
    .modal .content{background:#fff;border-radius:12px;max-width:420px;width:92%;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.25)}
    .modal h3{color:var(--pink-dark);margin:0 0 10px}
    .modal .actions{display:flex;gap:8px;justify-content:space-between;margin-top:14px}
    .pagination{display:flex;gap:6px;align-items:center;justify-content:flex-end;margin-top:8px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .badge.green{background:#E8F5E9;color:#1B5E20}
    .badge.red{background:#FFEBEE;color:#B71C1C}
  </style>
</head>
<body>
  <header>
    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Seal_of_Ko_Samui.png" alt="ตราเทศบาลนครเกาะสมุย" />
  </header>
  <div class="container">
    <h2>ระบบแจ้งงานดูดสิ่งปฏิกูล</h2>

    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="add">ระบบจอง</button>
      <button class="tab" data-tab="search">ค้นหาและรายงานผล</button>
      <button class="tab" data-tab="stats">สถิติ</button>
    </div>

    <!-- Add Booking -->
    <section id="tab-add" class="tab-content active" aria-labelledby="tab-add">
      <form id="bookingForm" novalidate>
        <div class="grid">
          <div class="form-group col-6">
            <label for="name">ชื่อลูกค้า <span class="badge red" id="nameErr" style="display:none">จำเป็น</span></label>
            <input id="name" type="text" required autocomplete="name" />
          </div>
          <div class="form-group col-6">
            <label for="phone">เบอร์โทรศัพท์</label>
            <input id="phone" type="tel" inputmode="tel" placeholder="0XXXXXXXXX" pattern="^0[0-9]{8,9}$" />
          </div>
          <div class="form-group col-4">
            <label for="house_number">เลขที่บ้าน</label>
            <input id="house_number" type="text" />
          </div>
          <div class="form-group col-4">
            <label for="village_number">หมู่บ้าน</label>
            <input id="village_number" type="text" />
          </div>
          <div class="form-group col-4">
            <label for="subdistrict">ตำบล</label>
            <select id="subdistrict"></select>
          </div>
          <div class="form-group col-6">
            <label for="staff">พนักงานผู้รับผิดชอบ</label>
            <select id="staff"></select>
          </div>
          <div class="form-group col-6">
            <label for="amount">ค่าบริการ (บาท)</label>
            <input id="amount" type="number" min="0" step="0.01" value="0" />
          </div>
          <div class="form-group col-6">
            <label><input id="paid" type="checkbox" /> ชำระแล้ว</label>
          </div>
          <div class="form-group col-6">
            <label><input id="completed" type="checkbox" /> งานเสร็จสิ้น</label>
          </div>
          <div class="form-group col-12">
            <label for="notes">หมายเหตุ</label>
            <textarea id="notes" rows="3"></textarea>
          </div>
          <div class="col-12">
            <button id="submitBtn" type="submit">แจ้งงาน</button>
          </div>
        </div>
      </form>
      <div id="message" class="message"></div>
    </section>

    <!-- Search & Report -->
    <section id="tab-search" class="tab-content" aria-labelledby="tab-search">
      <div class="toolbar">
        <div class="grid" style="width:100%">
          <div class="form-group col-4">
            <label for="searchName">ชื่อลูกค้า/เบอร์โทร</label>
            <input id="searchName" type="text" placeholder="ค้นหาด้วยชื่อหรือเบอร์โทร" />
          </div>
          <div class="form-group col-3">
            <label for="filterStaff">พนักงาน</label>
            <select id="filterStaff"></select>
          </div>
          <div class="form-group col-3">
            <label for="filterSubdistrict">ตำบล</label>
            <select id="filterSubdistrict"></select>
          </div>
          <div class="form-group col-2">
            <label for="filterCompleted">สถานะงาน</label>
            <select id="filterCompleted">
              <option value="">ทั้งหมด</option>
              <option value="Yes">เสร็จสิ้น</option>
              <option value="No">ยังไม่เสร็จสิ้น</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:end">
          <button id="btnFilter" class="btn-outline">ค้นหา/กรอง</button>
          <button id="btnExport" class="btn-outline">Export CSV</button>
        </div>
      </div>
      <div id="bookingsTableContainer"></div>
      <div class="pagination" id="pagination" style="display:none">
        <button class="btn-outline" id="prevPage">ก่อนหน้า</button>
        <span id="pageInfo"></span>
        <button class="btn-outline" id="nextPage">ถัดไป</button>
      </div>
      <div id="viewMessage" class="message"></div>
    </section>

    <!-- Stats -->
    <section id="tab-stats" class="tab-content" aria-labelledby="tab-stats">
      <h3>สรุปสถิติ</h3>
      <div id="statsContent">
        <p><strong>จำนวนงานทั้งหมด:</strong> <span id="totalBookings">0</span></p>
        <p><strong>งานที่เสร็จสิ้น:</strong> <span id="completedBookings">0</span></p>
        <p><strong>งานที่ยังไม่เสร็จสิ้น:</strong> <span id="incompleteBookings">0</span></p>
        <p><strong>ยอดรวมค่าบริการทั้งหมด:</strong> <span id="totalAmount">0</span> บาท</p>
        <h4>งานต่อพนักงาน:</h4>
        <ul id="staffStatsList"></ul>
        <div class="chart-container"><canvas id="staffPerformanceChart"></canvas></div>
        <div class="chart-container"><canvas id="monthlyServicesChart"></canvas></div>
        <div class="chart-container"><canvas id="paidFreeChart"></canvas></div>
        <div class="chart-container"><canvas id="monthlyRevenueChart"></canvas></div>
        <div class="chart-container"><canvas id="subdistrictVolumeChart"></canvas></div>
      </div>
      <div id="statsMessage" class="message"></div>
    </section>
  </div>

  <footer>
    <p>&copy;2025 ระบบให้บริการรถดูดสิ่งปฏิกูล กองช่างสุขาภิบาล โดย นายธีรศักดิ์ พูลเขาล้าน</p>
  </footer>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="modal" style="display:none">
    <div class="content">
      <h3 id="modalTitle">ยืนยันการลบ?</h3>
      <p id="modalBody">คุณต้องการลบรายการนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
      <div class="actions">
        <button class="btn-red" id="confirmYesBtn">ใช่</button>
        <button class="btn-outline" id="confirmNoBtn">ไม่</button>
      </div>
    </div>
  </div>

  <script>
  'use strict';
  // =================== CONFIG ===================
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyyahkXofdS557MnH_9nHJm7K_a5Lo7LNIp87_E4ly2wiJ9zg50tZjNkWIXha1ExVcUpA/exec';
  const STAFF_OPTIONS = ["ศุภชัย เปี่ยมประถม","ไพรวัลย์ คำชาลี","ชวลิต ใจแผ้ว","ชาคริต ปัญญา"];
  const SUBDISTRICT_OPTIONS = ["อ่างทอง","ลิปะน้อย","ตลิ่งงาม","หน้าเมือง","มะเร็ต","บ่อผุด","แม่น้ำ"];
  const RATE_PER_CUBIC_METER = 250; // บาท/ลบ.ม.

  // =================== STATE ===================
  let allBookingsData = [];
  let editingRowTimestamp = null;
  let deleteConfirmTimestamp = null;
  let filteredCache = [];
  let currentPage = 1;
  const perPage = 20;

  // Chart instances
  let staffPerformanceChart = null;
  let monthlyServicesChart = null;
  let paidFreeChart = null;
  let monthlyRevenueChart = null;
  let subdistrictVolumeChart = null;

  // =================== UTILS ===================
  const nf = new Intl.NumberFormat('th-TH');
  const nfc = new Intl.NumberFormat('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  function getLast12MonthsFormatted(){
    const months = [];
    const today = new Date();
    for(let i=0;i<12;i++){
      const d = new Date(today.getFullYear(), today.getMonth()-i, 1);
      months.unshift(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);
    }
    return months;
  }
  function formatMonthYearToThai(ym){
    const [y,m] = ym.split('-');
    const d = new Date(Number(y), Number(m)-1, 1);
    return d.toLocaleString('th-TH', { month: 'long', year: 'numeric' });
  }
  function debounce(fn, ms=300){
    let t;
    return function debounced(){
      const args = arguments;
      clearTimeout(t);
      t = setTimeout(function(){ fn.apply(null, args); }, ms);
    };
  }
  function displayMessage(msg, type, target='message'){
    const el = document.getElementById(target);
    el.textContent = msg;
    el.className = `message ${type}`;
    el.style.display = 'block';
  }
  function populateSelectOptions(){
    const staffNodes = [document.getElementById('staff'), document.getElementById('filterStaff')];
    staffNodes.forEach(function(sel){
      sel.innerHTML = '<option value="">' + (sel.id==='filterStaff'?'ทั้งหมด':'เลือกพนักงาน') + '</option>' +
        STAFF_OPTIONS.map(function(o){ return `<option value="${o}">${o}</option>`; }).join('');
    });
    const subNodes = [document.getElementById('subdistrict'), document.getElementById('filterSubdistrict')];
    subNodes.forEach(function(sel){
      sel.innerHTML = '<option value="">' + (sel.id==='filterSubdistrict'?'ทั้งหมด':'เลือกตำบล') + '</option>' +
        SUBDISTRICT_OPTIONS.map(function(o){ return `<option value="${o}">${o}</option>`; }).join('');
    });
  }
  function saveActiveTabToStorage(id){ localStorage.setItem('fecal.activeTab', id); }
  function getActiveTabFromStorage(){ return localStorage.getItem('fecal.activeTab') || 'add'; }

  // Safe HTML escape
  function sanitize(str){
    const s = String(str == null ? '' : str);
    return s.replace(/[&<>"']/g, function(ch){
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
      return map[ch];
    });
  }

  // JSONP helper (no eval)
  function fetchJSONP(url, callbackParam){
    if(!callbackParam){ callbackParam = 'callback'; }
    return new Promise(function(resolve, reject){
      const cbName = 'jsonp_cb_' + Math.random().toString(36).slice(2);
      const script = document.createElement('script');
      const sep = url.indexOf('?') !== -1 ? '&' : '?';
      let finished = false;
      const timeout = setTimeout(function(){ done(new Error('JSONP timeout')); }, 15000);
      function done(err, data){
        if(finished) return; finished = true;
        clearTimeout(timeout);
        if(script.parentNode){ script.parentNode.removeChild(script); }
        delete window[cbName];
        if(err){ reject(err); } else { resolve(data); }
      }
      window[cbName] = function(data){ done(null, data); };
      script.src = url + sep + callbackParam + '=' + cbName;
      script.onerror = function(){ done(new Error('JSONP network error')); };
      document.body.appendChild(script);
    });
  }
  function appsScriptRequest(action, payload){
    const base = WEB_APP_URL + '?action=' + encodeURIComponent(action);
    if(payload){
      return fetchJSONP(base + '&data=' + encodeURIComponent(JSON.stringify(payload)), 'callback');
    }
    return fetchJSONP(base, 'callback');
  }

  // =================== TABS ===================
  document.querySelectorAll('.tab').forEach(function(btn){
    btn.addEventListener('click', function(){
      document.querySelectorAll('.tab').forEach(function(b){ b.classList.remove('active'); });
      btn.classList.add('active');
      const id = btn.getAttribute('data-tab');
      document.querySelectorAll('.tab-content').forEach(function(s){ s.classList.remove('active'); });
      document.getElementById('tab-' + id).classList.add('active');
      saveActiveTabToStorage(id);
      if(id==='search'){ fetchAndRenderAllBookings(false); }
      if(id==='stats'){ fetchAndRenderAllBookings(true); }
    });
  });

  // =================== ADD BOOKING ===================
  document.getElementById('bookingForm').addEventListener('submit', function(e){
    e.preventDefault();
    const name = document.getElementById('name');
    const phone = document.getElementById('phone');
    const nameErr = document.getElementById('nameErr');
    nameErr.style.display = name.value.trim() ? 'none' : 'inline-block';
    if(!name.value.trim()){ name.focus(); return; }
    if(phone.value && !/^0\d{8,9}$/.test(phone.value)){
      displayMessage('รูปแบบเบอร์โทรไม่ถูกต้อง','error');
      phone.focus();
      return;
    }

    const bookingData = {
      timestamp: new Date().toISOString(),
      name: name.value.trim(),
      phone: phone.value.trim(),
      house_number: document.getElementById('house_number').value.trim(),
      village_number: document.getElementById('village_number').value.trim(),
      subdistrict: document.getElementById('subdistrict').value,
      staff: document.getElementById('staff').value,
      amount: parseFloat(document.getElementById('amount').value) || 0,
      paid: document.getElementById('paid').checked,
      completed: document.getElementById('completed').checked,
      notes: document.getElementById('notes').value.trim()
    };

    const btn = document.getElementById('submitBtn');
    btn.disabled = true; btn.textContent = 'กำลังส่ง...';
    appsScriptRequest('addBooking', bookingData)
      .then(function(res){
        if(res && res.success){
          displayMessage('แจ้งงานสำเร็จ!','success');
          document.getElementById('bookingForm').reset();
          document.getElementById('staff').value = '';
          document.getElementById('subdistrict').value = '';
        } else {
          displayMessage('แจ้งงานไม่สำเร็จ: ' + (res && res.error ? res.error : 'ไม่ทราบสาเหตุ'),'error');
        }
      })
      .catch(function(err){ displayMessage('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + err.message,'error'); })
      .finally(function(){ btn.disabled = false; btn.textContent = 'แจ้งงาน'; });
  });

  // =================== SEARCH & REPORT ===================
  document.getElementById('btnFilter').addEventListener('click', function(){ applyFilters(); });
  document.getElementById('searchName').addEventListener('input', debounce(applyFilters, 350));
  document.getElementById('filterStaff').addEventListener('change', applyFilters);
  document.getElementById('filterSubdistrict').addEventListener('change', applyFilters);
  document.getElementById('filterCompleted').addEventListener('change', applyFilters);

  document.getElementById('prevPage').addEventListener('click', function(){ if(currentPage>1){ currentPage--; renderBookingsTable(filteredCache); } });
  document.getElementById('nextPage').addEventListener('click', function(){ const max = Math.ceil(filteredCache.length / perPage) || 1; if(currentPage < max){ currentPage++; renderBookingsTable(filteredCache); } });

  document.getElementById('btnExport').addEventListener('click', function(){
    if(!filteredCache.length){ displayMessage('ไม่มีข้อมูลสำหรับส่งออก','info','viewMessage'); return; }
    const headers = Object.keys(filteredCache[0]);
    const csv = [headers.join(',')]
      .concat(filteredCache.map(function(o){
        return headers.map(function(h){
          const cell = String(o[h] == null ? '' : o[h]).replace(/\"/g, '""');
          return '"' + cell + '"';
        }).join(',');
      }))
      .join('\n');
    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'bookings.csv'; a.click();
    URL.revokeObjectURL(url);
  });

  function fetchAndRenderAllBookings(forStats){
    if(forStats == null){ forStats = false; }
    const msgId = forStats ? 'statsMessage' : 'viewMessage';
    document.getElementById(msgId).style.display = 'none';
    if(!forStats){
      document.getElementById('bookingsTableContainer').innerHTML = '<p>กำลังโหลดข้อมูล...</p>';
    } else {
      ['totalBookings','completedBookings','incompleteBookings','totalAmount'].forEach(function(id){ document.getElementById(id).textContent = 'กำลังโหลด...'; });
      document.getElementById('staffStatsList').innerHTML = '<li>กำลังโหลด...</li>';
      destroyAllChartsAndResetCanvases();
    }
    appsScriptRequest('getBookings')
      .then(function(res){
        if(res && res.success){
          allBookingsData = res.data || [];
          if(forStats){ renderStatistics(allBookingsData); } else { applyFilters(); }
        } else {
          displayMessage('ไม่สามารถโหลดข้อมูลได้: ' + (res && res.error ? res.error : 'ไม่ทราบสาเหตุ'),'error',msgId);
          if(!forStats){ document.getElementById('bookingsTableContainer').innerHTML = ''; }
        }
      })
      .catch(function(err){
        displayMessage('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + err.message,'error',msgId);
        if(!forStats){ document.getElementById('bookingsTableContainer').innerHTML = ''; }
      });
  }

  function applyFilters(){
    const search = document.getElementById('searchName').value.toLowerCase();
    const fStaff = document.getElementById('filterStaff').value;
    const fSub = document.getElementById('filterSubdistrict').value;
    const fCompleted = document.getElementById('filterCompleted').value;
    filteredCache = allBookingsData.filter(function(b){
      const byName = !search || (String(b.name||'').toLowerCase().includes(search) || String(b.phone||'').toLowerCase().includes(search));
      const byStaff = !fStaff || b.staff === fStaff;
      const bySub = !fSub || b.subdistrict === fSub;
      const byComp = !fCompleted || (fCompleted === 'Yes' ? b.completed === true : b.completed === false);
      return byName && byStaff && bySub && byComp;
    });
    currentPage = 1;
    renderBookingsTable(filteredCache);
  }

  function renderBookingsTable(rows){
    const container = document.getElementById('bookingsTableContainer');
    if(!rows.length){
      container.innerHTML = '<p>ไม่พบรายการงานที่ตรงกับเงื่อนไขการค้นหา</p>';
      document.getElementById('pagination').style.display = 'none';
      return;
    }

    const headers = Object.keys(rows[0]);
    const start = (currentPage - 1) * perPage;
    const end = start + perPage;
    const pageRows = rows.slice(start, end);
    const totalPages = Math.ceil(rows.length / perPage) || 1;
    document.getElementById('pagination').style.display = totalPages > 1 ? 'flex' : 'none';
    document.getElementById('pageInfo').textContent = 'หน้า ' + currentPage + ' / ' + totalPages;

    var html = '<table><thead><tr>';
    headers.filter(function(h){ return h.toLowerCase() !== 'timestamp'; }).forEach(function(h){
      const display = h.replace(/([A-Z])/g,' $1').replace(/^./,function(c){ return c.toUpperCase(); });
      html += '<th>' + sanitize(display) + '</th>';
    });
    html += '<th>การทำงาน</th></tr></thead><tbody>';

    pageRows.forEach(function(b){
      html += '<tr data-timestamp="' + sanitize(b.timestamp) + '">';
      headers.filter(function(h){ return h.toLowerCase() !== 'timestamp'; }).forEach(function(h){
        var val = b[h];
        if(h === 'paid' || h === 'completed'){ val = val ? 'Yes' : 'No'; }
        html += '<td><span class="display-mode">' + sanitize(val) + '</span>' + renderEditControl(h, b) + '</td>';
      });
      html += '<td><div class="row-actions">\
        <button class="edit-btn btn-outline">แก้ไข</button>\
        <button class="save-btn btn-green" style="display:none">บันทึก</button>\
        <button class="cancel-btn btn-outline" style="display:none">ยกเลิก</button>\
        <button class="delete-btn btn-red">ลบ</button>\
      </div></td>';
      html += '</tr>';
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function renderEditControl(field, b){
    const val = b[field] == null ? '' : b[field];
    if(field === 'amount'){
      return '<input class="edit-mode" data-field="amount" type="number" step="0.01" min="0" value="' + sanitize(val) + '" style="display:none;width:120px">';
    }
    if(field === 'paid'){
      return '<input class="edit-mode" data-field="paid" type="checkbox" ' + (b.paid ? 'checked' : '') + ' style="display:none">';
    }
    if(field === 'completed'){
      return '<select class="edit-mode" data-field="completed" style="display:none">' +
             '<option value="true" ' + (b.completed ? 'selected' : '') + '>Yes</option>' +
             '<option value="false" ' + (!b.completed ? 'selected' : '') + '>No</option>' +
             '</select>';
    }
    if(field === 'staff'){
      return '<select class="edit-mode" data-field="staff" style="display:none">' +
             '<option value="">เลือกพนักงาน</option>' +
             STAFF_OPTIONS.map(function(o){ return '<option ' + (o===b.staff?'selected':'') + ' value="' + sanitize(o) + '">' + sanitize(o) + '</option>'; }).join('') +
             '</select>';
    }
    if(field === 'subdistrict'){
      return '<select class="edit-mode" data-field="subdistrict" style="display:none">' +
             '<option value="">เลือกตำบล</option>' +
             SUBDISTRICT_OPTIONS.map(function(o){ return '<option ' + (o===b.subdistrict?'selected':'') + ' value="' + sanitize(o) + '">' + sanitize(o) + '</option>'; }).join('') +
             '</select>';
    }
    return '<input class="edit-mode" data-field="' + sanitize(field) + '" type="text" value="' + sanitize(val) + '" style="display:none;min-width:140px">';
  }

  const originalRowValues = Object.create(null);

  // Event delegation for table actions
  document.getElementById('bookingsTableContainer').addEventListener('click', function(e){
    const btn = e.target.closest('button');
    if(!btn){ return; }
    const row = e.target.closest('tr');
    if(!row){ return; }
    const ts = row.getAttribute('data-timestamp');
    if(btn.classList.contains('edit-btn')){ enterEditMode(row, ts); }
    else if(btn.classList.contains('save-btn')){ saveBooking(row, ts); }
    else if(btn.classList.contains('cancel-btn')){ cancelEdit(row, ts); }
    else if(btn.classList.contains('delete-btn')){ showConfirmModal(ts, row.querySelector('td').innerText.trim()); }
  });

  function enterEditMode(row, timestamp){
    editingRowTimestamp = timestamp;
    const booking = allBookingsData.find(function(b){ return b.timestamp === timestamp; });
    originalRowValues[timestamp] = booking ? JSON.parse(JSON.stringify(booking)) : {};
    row.querySelectorAll('.display-mode').forEach(function(s){ s.style.display='none'; });
    row.querySelectorAll('.edit-mode').forEach(function(el){ el.style.display = (el.type === 'checkbox' ? 'inline' : 'inline-block'); });
    row.querySelector('.edit-btn').style.display='none';
    row.querySelector('.save-btn').style.display='inline-block';
    row.querySelector('.cancel-btn').style.display='inline-block';
    row.querySelector('.delete-btn').style.display='none';
  }

  function saveBooking(row, timestamp){
    const updated = { timestamp: timestamp };
    row.querySelectorAll('.edit-mode').forEach(function(el){
      const field = el.getAttribute('data-field');
      if(!field){ return; }
      if(el.tagName === 'SELECT'){
        updated[field] = (field === 'completed') ? (el.value === 'true') : el.value;
      } else if(el.type === 'checkbox'){
        updated[field] = !!el.checked;
      } else if(el.type === 'number'){
        updated[field] = parseFloat(el.value) || 0;
      } else {
        updated[field] = el.value;
      }
    });
    displayMessage('กำลังบันทึกข้อมูล...','info','viewMessage');
    appsScriptRequest('updateBooking', updated)
      .then(function(res){
        if(res && res.success){
          displayMessage('บันทึกข้อมูลสำเร็จ!','success','viewMessage');
          fetchAndRenderAllBookings(false);
          editingRowTimestamp = null;
        } else {
          displayMessage('บันทึกข้อมูลไม่สำเร็จ: ' + (res && res.error ? res.error : 'ไม่ทราบสาเหตุ'),'error','viewMessage');
        }
      })
      .catch(function(err){
        displayMessage('เกิดข้อผิดพลาดในการบันทึก: ' + err.message,'error','viewMessage');
        exitEditMode(row);
      });
  }

  function cancelEdit(row, timestamp){
    const original = originalRowValues[timestamp];
    if(original){
      row.querySelectorAll('.edit-mode').forEach(function(el){
        const f = el.getAttribute('data-field');
        if(!(f in original)){ return; }
        if(el.type === 'checkbox'){ el.checked = !!original[f]; }
        else { el.value = original[f]; }
      });
    }
    exitEditMode(row);
  }

  function exitEditMode(row){
    row.querySelectorAll('.display-mode').forEach(function(s){ s.style.display='inline'; });
    row.querySelectorAll('.edit-mode').forEach(function(el){ el.style.display='none'; });
    row.querySelector('.edit-btn').style.display='inline-block';
    row.querySelector('.save-btn').style.display='none';
    row.querySelector('.cancel-btn').style.display='none';
    row.querySelector('.delete-btn').style.display='inline-block';
  }

  function showConfirmModal(timestamp, name){
    deleteConfirmTimestamp = timestamp;
    document.getElementById('modalTitle').textContent = 'ยืนยันการลบรายการ?';
    document.getElementById('modalBody').innerHTML = 'คุณต้องการลบรายการของ <strong>' + sanitize(name) + '</strong> ใช่หรือไม่? <br>การกระทำนี้ไม่สามารถย้อนกลับได้';
    document.getElementById('confirmModal').style.display = 'flex';
  }
  function hideConfirmModal(){
    document.getElementById('confirmModal').style.display = 'none';
    deleteConfirmTimestamp = null;
  }
  document.getElementById('confirmYesBtn').addEventListener('click', function(){
    if(!deleteConfirmTimestamp){ return; }
    hideConfirmModal();
    displayMessage('กำลังลบข้อมูล...','info','viewMessage');
    appsScriptRequest('deleteByTimestamp', { timestamp: deleteConfirmTimestamp })
      .then(function(res){
        if(res && res.success){
          displayMessage('ลบข้อมูลสำเร็จ!','success','viewMessage');
          fetchAndRenderAllBookings(false);
        } else {
          displayMessage('ลบข้อมูลไม่สำเร็จ: ' + (res && res.error ? res.error : 'ไม่ทราบสาเหตุ'),'error','viewMessage');
        }
      })
      .catch(function(err){ displayMessage('เกิดข้อผิดพลาดในการลบ: ' + err.message,'error','viewMessage'); });
  });
  document.getElementById('confirmNoBtn').addEventListener('click', hideConfirmModal);
  window.addEventListener('click', function(e){ if(e.target === document.getElementById('confirmModal')){ hideConfirmModal(); } });

  // =================== STATS ===================
  function destroyAllChartsAndResetCanvases(){
    [staffPerformanceChart, monthlyServicesChart, paidFreeChart, monthlyRevenueChart, subdistrictVolumeChart].forEach(function(c){ if(c){ c.destroy(); } });
    staffPerformanceChart = monthlyServicesChart = paidFreeChart = monthlyRevenueChart = subdistrictVolumeChart = null;
    ['staffPerformanceChart','monthlyServicesChart','paidFreeChart','monthlyRevenueChart','subdistrictVolumeChart'].forEach(function(id){
      const old = document.getElementById(id);
      const parent = old.parentNode;
      old.remove();
      const c = document.createElement('canvas');
      c.id = id;
      parent.appendChild(c);
    });
  }

  function renderStatistics(bookings){
    const total = bookings.length;
    const completed = bookings.filter(function(b){ return b.completed === true; }).length;
    const incomplete = total - completed;
    const totalAmount = bookings.reduce(function(s,b){ return s + (parseFloat(b.amount) || 0); }, 0);
    document.getElementById('totalBookings').textContent = nf.format(total);
    document.getElementById('completedBookings').textContent = nf.format(completed);
    document.getElementById('incompleteBookings').textContent = nf.format(incomplete);
    document.getElementById('totalAmount').textContent = nfc.format(totalAmount);

    const staffStats = Object.create(null);
    bookings.forEach(function(b){
      if(!b.staff){ return; }
      if(!staffStats[b.staff]){ staffStats[b.staff] = { total: 0, incomplete: 0 }; }
      staffStats[b.staff].total++;
      if(!b.completed){ staffStats[b.staff].incomplete++; }
    });
    const staffList = document.getElementById('staffStatsList');
    staffList.innerHTML = '';
    if(Object.keys(staffStats).length){
      Object.keys(staffStats).sort().forEach(function(s){
        const li = document.createElement('li');
        li.textContent = s + ': ' + staffStats[s].total + ' งาน (ยังไม่เสร็จ: ' + staffStats[s].incomplete + ' งาน)';
        staffList.appendChild(li);
      });
    } else {
      staffList.innerHTML = '<li>ไม่มีข้อมูลพนักงาน</li>';
    }

    const last12 = getLast12MonthsFormatted();
    const monthlyServices = Object.fromEntries(last12.map(function(m){ return [m,0]; }));
    const monthlyRevenue = Object.fromEntries(last12.map(function(m){ return [m,0]; }));
    let paidCount = 0, freeCount = 0;
    const subVolume = Object.fromEntries(SUBDISTRICT_OPTIONS.map(function(s){ return [s,0]; }));

    bookings.forEach(function(b){
      const d = new Date(b.timestamp);
      const ym = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
      if(last12.indexOf(ym) !== -1){
        monthlyServices[ym]++;
        if(b.paid){ monthlyRevenue[ym] += (parseFloat(b.amount) || 0); }
      }
      if(b.paid){ paidCount++; } else { freeCount++; }
      if(b.subdistrict){ subVolume[b.subdistrict] = (subVolume[b.subdistrict] || 0) + ((parseFloat(b.amount) || 0) / RATE_PER_CUBIC_METER); }
    });

    const staffLabels = Object.keys(staffStats).sort();
    const staffTotals = staffLabels.map(function(k){ return staffStats[k].total; });
    const staffIncomplete = staffLabels.map(function(k){ return staffStats[k].incomplete; });

    const ctx1 = document.getElementById('staffPerformanceChart').getContext('2d');
    staffPerformanceChart = new Chart(ctx1, { type: 'bar', data: { labels: staffLabels, datasets: [ { label: 'งานทั้งหมด', data: staffTotals, backgroundColor: '#FF66B2', borderColor: '#E6007A', borderWidth: 1 }, { label: 'งานที่ยังไม่เสร็จ', data: staffIncomplete, backgroundColor: '#F44336', borderColor: '#da190b', borderWidth: 1 } ]}, options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, title:{ display:true, text:'จำนวนงาน' } }, x:{ title:{ display:true, text:'พนักงาน' } } }, plugins:{ title:{ display:true, text:'จำนวนงานรวมและงานที่ยังไม่เสร็จต่อพนักงาน', font:{ size:16, weight:'bold' }, color:'#E6007A' } } } });

    const monthlyLabels = last12.map(formatMonthYearToThai);
    const monthlyServiceCounts = last12.map(function(m){ return monthlyServices[m]; });
    const ctx2 = document.getElementById('monthlyServicesChart').getContext('2d');
    monthlyServicesChart = new Chart(ctx2, { type: 'bar', data: { labels: monthlyLabels, datasets: [{ label: 'จำนวนการให้บริการ', data: monthlyServiceCounts, backgroundColor: '#FF99C8', borderColor: '#E6007A', borderWidth: 1 }] }, options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, title:{ display:true, text:'จำนวนงาน' } }, x:{ title:{ display:true, text:'เดือน' } } }, plugins:{ title:{ display:true, text:'จำนวนการให้บริการ 12 เดือนล่าสุด', font:{ size:16, weight:'bold' }, color:'#E6007A' }, legend:{ display:false } } } });

    const ctx3 = document.getElementById('paidFreeChart').getContext('2d');
    paidFreeChart = new Chart(ctx3, { type: 'pie', data: { labels: ['บริการเก็บเงิน','บริการฟรี'], datasets: [{ data: [paidCount, freeCount], backgroundColor: ['#4CAF50','#F44336'], borderColor: '#fff', borderWidth: 2 }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{ title:{ display:true, text:'สัดส่วนระหว่างบริการเก็บเงิน/ฟรี', font:{ size:16, weight:'bold' }, color:'#E6007A' }, tooltip:{ callbacks:{ label:function(ctx){ const v = ctx.parsed || 0; const t = ctx.dataset.data.reduce(function(a,c){return a+c;},0) || 1; return ctx.label + ': ' + v + ' งาน (' + (v*100/t).toFixed(2) + '%)'; } } } } } });

    const monthlyRevenueLabels = last12.map(formatMonthYearToThai);
    const monthlyRevenueAmounts = last12.map(function(m){ return monthlyRevenue[m]; });
    const ctx4 = document.getElementById('monthlyRevenueChart').getContext('2d');
    monthlyRevenueChart = new Chart(ctx4, { type: 'bar', data: { labels: monthlyRevenueLabels, datasets: [{ label: 'รายได้ (บาท)', data: monthlyRevenueAmounts, backgroundColor: '#FFB3C8', borderColor: '#E6007A', borderWidth: 1 }] }, options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, title:{ display:true, text:'รายได้ (บาท)' } }, x:{ title:{ display:true, text:'เดือน' } } }, plugins:{ title:{ display:true, text:'รายได้ต่อเดือน 12 เดือนล่าสุด', font:{ size:16, weight:'bold' }, color:'#E6007A' }, legend:{ display:false } } } });

    const subdistrictVolumeLabels = Object.keys(subVolume).sort(function(a,b){ return SUBDISTRICT_OPTIONS.indexOf(a) - SUBDISTRICT_OPTIONS.indexOf(b); });
    const subdistrictVolumeValues = subdistrictVolumeLabels.map(function(s){ return +subVolume[s].toFixed(2); });
    const ctx5 = document.getElementById('subdistrictVolumeChart').getContext('2d');
    subdistrictVolumeChart = new Chart(ctx5, { type: 'bar', data: { labels: subdistrictVolumeLabels, datasets: [{ label: 'ปริมาณ (ลบ.ม.)', data: subdistrictVolumeValues, backgroundColor: ['#FF99C8','#FFB3C8','#FFCDD2','#FFDDE3','#FFE7EA','#FFF0F5','#F8E0E0'], borderColor: '#E6007A', borderWidth: 1 }] }, options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, title:{ display:true, text:'ปริมาณ (ลูกบาศก์เมตร)' } }, x:{ title:{ display:true, text:'ตำบล' } } }, plugins:{ title:{ display:true, text:'ปริมาณสิ่งปฏิกูลแต่ละตำบล (ลบ.ม.)', font:{ size:16, weight:'bold' }, color:'#E6007A' }, legend:{ display:false } } } });

    if(total === 0){ document.getElementById('statsContent').innerHTML = '<p>ไม่พบข้อมูลสำหรับแสดงสถิติ</p>'; destroyAllChartsAndResetCanvases(); }
  }

  // =================== INIT ===================
  function restoreActiveTab(){
    const id = getActiveTabFromStorage();
    document.querySelectorAll('.tab').forEach(function(b){ b.classList.toggle('active', b.getAttribute('data-tab') === id); });
    document.querySelectorAll('.tab-content').forEach(function(s){ s.classList.toggle('active', s.id === 'tab-' + id); });
    if(id === 'search'){ fetchAndRenderAllBookings(false); }
    if(id === 'stats'){ fetchAndRenderAllBookings(true); }
  }

  document.addEventListener('DOMContentLoaded', function(){
    populateSelectOptions();
    restoreActiveTab();

    // ===== Self-tests (safe) =====
    try{
      console.assert(typeof debounce(function(){},200) === 'function', 'debounce should return a function');
      const testStr = "<>&\"'</>"; // <>&"'</>
      console.assert(sanitize(testStr) === '&lt;&gt;&amp;&quot;&#39;&lt;/>', 'sanitize mapping should match');
      const m = getLast12MonthsFormatted();
      console.assert(Array.isArray(m) && m.length === 12, 'getLast12MonthsFormatted length');
    }catch(_e){ console.warn('Self-test warnings:', _e); }
  });
  </script>
</body>
</html>
